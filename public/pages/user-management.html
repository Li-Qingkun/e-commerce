<!-- pages/user-management.html -->
<!-- 用户管理主内容 -->
<div class="page-header">
	<h2 class="page-title">用户管理</h2>
	<button class="btn-add-user" id="btnAddUser">
		<i class="fa fa-plus"></i> 新增用户
	</button>
</div>
<div class="card">
	<table class="table table-bordered table-hover">
		<thead>
			<tr>
				<th>序号</th>
				<th>用户名</th>
				<th>密码</th>
				<th>身份</th>
				<th>店铺列表</th>
				<th>创建时间</th>
				<th>最后修改时间</th>
				<th>操作</th>
			</tr>
		</thead>
		<tbody id="userTableBody">
			<!-- 动态加载用户数据 -->
		</tbody>
	</table>
</div>

<!-- 新增/编辑用户弹窗（迁移到子页面） -->
<div class="modal" id="userModal">
	<div class="modal-content">
		<div class="modal-header">
			<h3 class="modal-title" id="modalTitle">新增用户</h3>
			<i class="fa fa-times modal-close" id="modalClose"></i>
		</div>
		<div class="modal-body">
			<input type="hidden" id="editUserName">
			<div class="form-group">
				<label for="modalUserName">用户名</label>
				<input type="text" id="modalUserName" placeholder="请输入用户名（唯一）" autocomplete="new-password" readonly
					onfocus="this.removeAttribute('readonly');">
				<span class="duplicate-tip" id="userNameTip">用户名已存在！</span>
			</div>
			<div class="form-group">
				<label for="modalPassword">密码</label>
				<input type="password" id="modalPassword" placeholder="请输入密码" autocomplete="new-password">
			</div>
			<div class="form-group">
				<label for="modalConfirmPwd">确认密码</label>
				<input type="password" id="modalConfirmPwd" placeholder="请再次输入密码" autocomplete="new-password">
				<span class="password-tip" id="passwordTip">两次密码不一致！</span>
			</div>
			<div class="form-group">
				<label for="modalRole">用户身份</label>
				<select id="modalRole">
					<option value="normal">普通用户</option>
					<option value="admin">管理员</option>
				</select>
			</div>
			<div class="form-group">
				<label for="modalShopList">店铺列表</label>
				<input type="text" id="modalShopList" placeholder="请输入店铺名称，多个店铺用英文逗号分隔">
				<small class="text-muted">示例：XXX专卖店,XXX旗舰店</small>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn-cancel" id="btnModalCancel">取消</button>
			<button class="btn-save" id="btnModalSave">保存</button>
		</div>
	</div>
</div>

<!-- Toast 提示容器（子页面专属） -->
<div class="toast-container" id="toastContainer"></div>

<script>
	// 定义受保护的超级管理员账户
	// const PROTECTED_ADMIN_USER = 'admin';

	// 页面初始化
	function initUserManagement() {
		console.log('用户管理子页面初始化');

		// 加载用户数据
		loadAllUsers();

		// 绑定所有事件
		bindEvents();
	}

	// 绑定所有交互事件
	function bindEvents() {
		// 1. 新增用户按钮
		$('#btnAddUser').click(function() {
			console.log('点击新增用户按钮');
			openUserModal('add');
		});

		// 2. 编辑用户按钮
		$('#userTableBody').on('click', '.btn-edit-user', function() {
			console.log('点击编辑用户按钮');
			try {
				// 关键修复：从当前行的 data 属性获取正确数据，而非按钮的 data 属性
				const $tr = $(this).closest('tr'); // 获取当前行
				const userName = $tr.data('username'); // 从行获取用户名
				// 从行获取密码（如果行没有，再从按钮获取）
				const password = $tr.data('password') || $(this).data('password') || '';
				const role = $tr.data('role') || $(this).data('role') || 'normal';
				const shopList = $tr.data('shoplist') || $(this).data('shoplist') || [];
				const shopNames = shopList.map(shop => shop.shopName || '').join(',');

				console.log('编辑用户数据：', {
					userName,
					password,
					role,
					shopNames
				}); // 调试日志

				openUserModal('edit', {
					userName,
					password, // 现在是正确的用户密码
					role,
					shopNames
				});
			} catch (e) {
				console.error('编辑弹窗加载失败：', e);
				showToast('加载编辑数据失败，请重试！', 'error');
			}
		});

		// 3. 删除用户按钮
		$('#userTableBody').on('click', '.btn-delete-user', function() {
			const userName = $(this).data('username');
			deleteUser(userName);
		});

		// 4. 弹窗关闭按钮
		$('#modalClose, #btnModalCancel').click(function() {
			closeUserModal();
		});

		// 5. 点击弹窗外部关闭
		$('#userModal').click(function(e) {
			if (e.target === this) {
				closeUserModal();
			}
		});

		// 6. 阻止弹窗内容区事件冒泡
		$('.modal-content').click(function(e) {
			e.stopPropagation();
		});

		// 7. 保存用户按钮
		$('#btnModalSave').click(function() {
			saveUser();
		});

		// 8. 实时校验用户名
		// let userNameCheckTimer = null;
		// $('#modalUserName').on('input blur', function() {
		// 	const $this = $(this);
		// 	const userName = $this.val().trim();
		// 	const $tip = $('#userNameTip');
		// 	const $saveBtn = $('#btnModalSave');

		// 	// 如果用户名为空，隐藏提示并启用保存按钮
		// 	if (!userName) {
		// 		$tip.removeClass('show');
		// 		$this.removeClass('error');
		// 		clearTimeout(userNameCheckTimer);
		// 		validatePasswordForm(); // 重新校验密码，更新保存按钮状态
		// 		return;
		// 	}

		// 	clearTimeout(userNameCheckTimer);
		// 	userNameCheckTimer = setTimeout(() => {
		// 		fetch(`/data/userdata.json?_=${new Date().getTime()}`, {
		// 				cache: 'no-cache'
		// 			})
		// 			.then(res => res.ok ? res.json() : [])
		// 			.then(data => {
		// 				if (!Array.isArray(data)) data = [];
		// 				const editUserName = $('#editUserName').val().trim();
		// 				const isExist = data.some(u =>
		// 					u.userName && u.userName.trim() === userName && u.userName !==
		// 					editUserName
		// 				);

		// 				if (isExist) {
		// 					$tip.addClass('show');
		// 					$this.addClass('error');
		// 					$('#btnModalSave').prop('disabled', true).css('opacity', '0.6');
		// 				} else {
		// 					$tip.removeClass('show');
		// 					$this.removeClass('error');
		// 					validatePasswordForm(); // 重新校验密码，更新保存按钮状态
		// 				}
		// 			})
		// 			.catch(err => {
		// 				console.error('实时校验用户名失败：', err);
		// 				$tip.removeClass('show');
		// 				validatePasswordForm();
		// 			});
		// 	}, 500);
		// });

		// 9. 实时校验密码一致性
		$('#modalPassword, #modalConfirmPwd').on('input', validatePasswordForm);
	}

	/**
	 * 显示Toast提示
	 */
	function showToast(message, type = 'info', duration = 3000) {
		const $container = $('#toastContainer');
		const $toast = $(`
        <div class="toast ${type}">
            ${message}
        </div>
    `);
		$container.append($toast);
		setTimeout(() => {
			$toast.remove();
		}, duration);
	}

	/**
	 * 校验密码表单
	 */
	function validatePasswordForm() {
		const isEdit = !!$('#editUserName').val().trim();
		const password = $('#modalPassword').val().trim();
		const confirmPwd = $('#modalConfirmPwd').val().trim();
		const $tip = $('#passwordTip');
		const $pwdInput = $('#modalConfirmPwd');
		const $saveBtn = $('#btnModalSave');

		// 编辑模式：密码可选（为空则不修改）
		if (isEdit && !password && !confirmPwd) {
			$tip.removeClass('show');
			$pwdInput.removeClass('error');
			return true;
		}

		let isValid = true;
		// 仅校验密码一致性（如果输入了密码）
		if (password || confirmPwd) {
			if (password !== confirmPwd) {
				$tip.addClass('show');
				$pwdInput.addClass('error');
				isValid = false;
			} else {
				$tip.removeClass('show');
				$pwdInput.removeClass('error');
			}
		} else {
			// 如果密码和确认密码都为空，隐藏提示
			$tip.removeClass('show');
			$pwdInput.removeClass('error');
		}

		const userNameExist = $('#userNameTip').hasClass('show');
		if (userNameExist) {
			isValid = false;
		}

		$saveBtn.prop('disabled', !isValid);
		return isValid;
	}

	/**
	 * 打开用户弹窗
	 */
	function openUserModal(type, userData = {}) {
		const {
			userName = '', password = '', role = 'normal', shopNames = ''
		} = userData;

		// 重置弹窗状态
		$('#userNameTip').removeClass('show');
		$('#modalUserName').removeClass('error').val('');
		$('#passwordTip').removeClass('show');
		$('#modalConfirmPwd').removeClass('error').val('');
		$('#modalPassword').val('');
		$('#modalShopList').val('');
		$('#modalRole').val('normal').prop('disabled', false);
		$('#editUserName').val('');
		$('#btnModalSave').prop('disabled', true).css('opacity', '0.6');

		if (type === 'add') {
			$('#modalTitle').text('新增用户');
			$('#editUserName').val(''); // 关键：清空隐藏的编辑用户名
			$('#modalUserName').val('').removeAttr('disabled').removeClass('error');
			$('#modalPassword').val(''); // 清空密码
			$('#modalConfirmPwd').val(''); // 清空确认密码
			$('#modalRole').val('normal'); // 重置为普通用户
			$('#modalShopList').val('').removeAttr('disabled'); // 清空店铺列表

			// 新增模式：重新绑定用户名校验事件
			bindUserNameCheck();
		} else if (type === 'edit') {
			// 保护逻辑：admin账户禁用身份修改
			if (userName === PROTECTED_ADMIN_USER) {
				$('#modalRole').val('admin').prop('disabled', true);
				showToast('超级管理员账户身份禁止修改！', 'info');
			} else {
				$('#modalRole').val(role).prop('disabled', false);
			}

			$('#modalTitle').text('编辑用户');
			$('#editUserName').val(userName);
			$('#modalUserName').val(userName).attr('disabled', true).removeClass('error');
			$('#modalPassword').val(password);
			$('#modalConfirmPwd').val(password);
			$('#modalShopList').val(shopNames).removeAttr('disabled');

			// 编辑模式：解绑用户名的校验事件，避免误报
			$('#modalUserName').off('input blur');

			// 编辑模式下，因为已有数据，所以启用保存按钮
			$('#btnModalSave').prop('disabled', false).css('opacity', '1');
		}

		// 显示弹窗（关键：添加show类+强制设置display）
		$('#userModal').addClass('show').css({
			display: 'flex',
			justifyContent: 'center',
			alignItems: 'center'
		});

		// 聚焦输入框
		setTimeout(() => {
			type === 'add' ? $('#modalUserName').focus() : $('#modalPassword').focus();
		}, 100);
	}

	// 实时校验用户名（提取为独立函数）
	function bindUserNameCheck() {
		// 先解绑，避免重复绑定
		$('#modalUserName').off('input blur');

		let userNameCheckTimer = null;
		$('#modalUserName').on('input blur', function() {
			const $this = $(this);
			const userName = $this.val().trim();
			const $tip = $('#userNameTip');
			const $saveBtn = $('#btnModalSave');

			// 如果用户名为空，隐藏提示并启用保存按钮
			if (!userName) {
				$tip.removeClass('show');
				$this.removeClass('error');
				clearTimeout(userNameCheckTimer);
				validatePasswordForm(); // 重新校验密码，更新保存按钮状态
				return;
			}

			clearTimeout(userNameCheckTimer);
			userNameCheckTimer = setTimeout(() => {
				fetch(`/data/userdata.json?_=${new Date().getTime()}`, {
						cache: 'no-cache'
					})
					.then(res => res.ok ? res.json() : [])
					.then(data => {
						if (!Array.isArray(data)) data = [];
						const editUserName = $('#editUserName').val().trim();
						const isExist = data.some(u =>
							u.userName && u.userName.trim() === userName && u.userName !==
							editUserName
						);

						if (isExist) {
							$tip.addClass('show');
							$this.addClass('error');
							$saveBtn.prop('disabled', true).css('opacity', '0.6');
						} else {
							$tip.removeClass('show');
							$this.removeClass('error');
							validatePasswordForm(); // 重新校验密码，更新保存按钮状态
						}
					})
					.catch(err => {
						console.error('实时校验用户名失败：', err);
						$tip.removeClass('show');
						validatePasswordForm();
					});
			}, 500);
		});
	}

	/**
	 * 关闭用户弹窗
	 */
	function closeUserModal() {
		$('#userModal').removeClass('show').css('display', 'none');

		// 重置弹窗内容
		setTimeout(() => {
			$('#modalTitle').text('新增用户');
			$('#editUserName').val('');
			$('#modalUserName').val('').removeAttr('disabled').removeClass('error');
			$('#modalPassword').val('');
			$('#modalConfirmPwd').val('');
			$('#modalRole').val('normal');
			$('#modalShopList').val('').removeAttr('disabled');
			$('#userNameTip').removeClass('show');
			$('#passwordTip').removeClass('show');
			$('#btnModalSave').prop('disabled', false).css('opacity', '1');
		}, 300);
	}

	/**
	 * 加载所有用户数据
	 */
	function loadAllUsers() {
		const $tbody = $('#userTableBody');
		$tbody.empty().append('<tr><td colspan="8" class="empty-tip">加载中...</td></tr>');

		const timestamp = new Date().getTime();
		fetch(`/data/userdata.json?_=${timestamp}`, {
				method: 'GET',
				cache: 'no-cache',
				headers: {
					'Cache-Control': 'no-cache',
					'Pragma': 'no-cache'
				}
			})
			.then(response => {
				if (response.ok) {
					return response.json();
				} else if (response.status === 404) {
					$tbody.empty().append('<tr><td colspan="8" class="empty-tip">暂无用户数据</td></tr>');
					return [];
				}
				throw new Error(`获取用户数据失败 [${response.status}]`);
			})
			.then(userData => {
				$tbody.empty();
				if (!Array.isArray(userData) || userData.length === 0) {
					$tbody.append('<tr><td colspan="8" class="empty-tip">暂无用户数据</td></tr>');
					return;
				}

				userData.forEach((user, index) => {
					const createTime = user.createTime ? new Date(user.createTime).toLocaleString() : '未知';
					const updateTime = user.updateTime ? new Date(user.updateTime).toLocaleString() : '未知';
					const showPwd = user.password ? user.password.substring(0, 3) + '****' : '未设置';
					const userRole = user.role || 'normal';
					const roleText = userRole === 'admin' ? '管理员' : '普通用户';
					const roleClass = userRole === 'admin' ? 'admin' : 'normal';
					const isProtected = user.userName === PROTECTED_ADMIN_USER;

					let shopHtml = '';
					if (user.shopList && user.shopList.length > 0) {
						user.shopList.forEach(shop => {
							shopHtml += `<span class="shop-list-tag">${shop.shopName || '-'}</span>`;
						});
					} else {
						shopHtml = '-';
					}

					// 渲染用户行时，给行添加完整的 data 属性
					const $tr = $(`
					    <tr data-username="${user.userName}" 
					        data-password="${user.password || ''}" 
					        data-role="${userRole}"
					        data-shoplist='${JSON.stringify(user.shopList || [])}'>
					        <td>${index + 1}</td>
					        <td>${user.userName || '-'}</td>
					        <td>${showPwd}</td>
					        <td><span class="role-tag ${roleClass}">${roleText}</span></td>
					        <td>${shopHtml}</td>
					        <td>${createTime}</td>
					        <td>${updateTime}</td>
					        <td></td>
					    </tr>
					`);

					// const $tr = $(`
					//                <tr data-username="${user.userName}">
					//                    <td>${index + 1}</td>
					//                    <td>${user.userName || '-'}</td>
					//                    <td>${showPwd}</td>
					//                    <td><span class="role-tag ${roleClass}">${roleText}</span></td>
					//                    <td>${shopHtml}</td>
					//                    <td>${createTime}</td>
					//                    <td>${updateTime}</td>
					//                    <td></td>
					//                </tr>
					//            `);

					// 编辑按钮
					// const $editBtn = $(
					// 	`<button class="btn btn-sm btn-primary btn-edit-user ${isProtected ? 'disabled' : ''}" 
					//                        ${isProtected ? 'title="超级管理员账户部分操作受限"' : ''}>
					//                    <i class="fa fa-edit"></i> 编辑
					//                </button>`
					// );
					// $editBtn.data('username', user.userName);
					// $editBtn.data('password', user.password || '');
					// $editBtn.data('role', userRole);
					// $editBtn.data('shoplist', user.shopList || []);

					// 编辑按钮只保留基础标识，不再存储完整数据
					const $editBtn = $(
						`<button class="btn btn-sm btn-primary btn-edit-user ${isProtected ? 'disabled' : ''}" 
					            ${isProtected ? 'title="超级管理员账户部分操作受限"' : ''}>
					        <i class="fa fa-edit"></i> 编辑
					    </button>`
					);
					// 移除按钮的 data 绑定，统一从行获取
					// $editBtn.data('username', user.userName); // 删除
					// $editBtn.data('password', user.password || ''); // 删除
					// $editBtn.data('role', userRole); // 删除
					// $editBtn.data('shoplist', user.shopList || []); // 删除

					// 删除按钮
					const $deleteBtn = $(
						`<button class="btn btn-sm btn-danger btn-delete-user ${isProtected ? 'disabled' : ''}" 
                            ${isProtected ? 'title="超级管理员账户禁止删除"' : ''}>
                        <i class="fa fa-trash"></i> 删除
                    </button>`
					);
					$deleteBtn.data('username', user.userName);

					$tr.find('td:last-child').append($editBtn).append(' ').append($deleteBtn);
					$tbody.append($tr);
				});
			})
			.catch(err => {
				console.error('加载用户数据失败：', err);
				$tbody.empty().append('<tr><td colspan="8" class="empty-tip">加载用户数据失败</td></tr>');
			});
	}

	/**
	 * 保存用户
	 */
	function saveUser() {
		const editUserName = $('#editUserName').val().trim();
		const userName = $('#modalUserName').val().trim();
		const password = $('#modalPassword').val().trim();
		const confirmPwd = $('#modalConfirmPwd').val().trim();
		const userRole = $('#modalRole').val() || 'normal';
		const shopInput = $('#modalShopList').val().trim();

		// 保护逻辑
		if (editUserName === PROTECTED_ADMIN_USER && userRole !== 'admin') {
			showToast('超级管理员账户身份禁止修改！', 'error');
			// 记录失败日志
			recordOperationLog('编辑用户', `尝试修改超级管理员【${editUserName}】身份，操作被拒绝`, 'fail');
			return;
		}

		// 基础校验
		if (!userName) {
			showToast('请输入用户名！', 'error');
			recordOperationLog(editUserName ? '编辑用户' : '新增用户', `用户名为空，操作失败`, 'fail');
			return;
		}

		if (password || confirmPwd) {
			if (password !== confirmPwd) {
				showToast('两次密码输入不一致！', 'error');
				return;
			}
		}

		if (!shopInput) {
			showToast('请输入店铺名称！', 'error');
			return;
		}

		// 处理店铺列表
		const shopList = shopInput.split(',')
			.map(shop => shop.trim())
			.filter(shop => shop)
			.map(shop => ({
				shopName: shop
			}));
		const now = new Date().toISOString();

		// 请求最新数据并保存
		fetch(`/data/userdata.json?_=${new Date().getTime()}`, {
				method: 'GET',
				cache: 'no-cache',
				headers: {
					'Cache-Control': 'no-cache',
					'Pragma': 'no-cache'
				}
			})
			.then(response => {
				if (response.ok) return response.json();
				if (response.status === 404) return [];
				throw new Error(`获取最新用户数据失败 [${response.status}]`);
			})
			.then(latestUserData => {
				if (!Array.isArray(latestUserData)) latestUserData = [];
				let newUserData = [...latestUserData];

				// 新增用户
				if (!editUserName) {
					const isUserNameExist = latestUserData.some(user =>
						user.userName && user.userName.trim() === userName
					);
					if (isUserNameExist) {
						showToast(`用户名【${userName}】已存在！`, 'error');
						throw new Error(`用户名重复：${userName}`);
					}
					newUserData.push({
						userName: userName,
						password: password,
						role: userRole,
						shopList: shopList,
						createTime: now,
						updateTime: now
					});
				} else {
					// 编辑用户
					newUserData = newUserData.map(user => {
						if (user.userName === editUserName) {
							return {
								...user,
								shopList: shopList,
								password: password || user.password,
								role: editUserName === PROTECTED_ADMIN_USER ? 'admin' : userRole,
								updateTime: now
							};
						}
						return user;
					});
				}

				// 提交保存
				return fetch('/aspx/SaveUserData.aspx', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'
					},
					body: `data=${encodeURIComponent(JSON.stringify(newUserData, null, 2))}`
				});
			})
			.then(response => {
				if (!response.ok) throw new Error(`保存请求失败 [${response.status}]`);
				return response.text();
			})
			.then(text => {
				let res = {
					success: false
				};
				try {
					res = JSON.parse(text);
				} catch (e) {
					res.success = text.includes('success') || text.includes('成功');
				}

				if (!res.success) throw new Error(res.msg || '保存失败');

				// 记录成功日志
				const operationType = editUserName ? '编辑用户' : '新增用户';
				const operationDesc =
					`${operationType}【${userName}】成功，身份：${userRole === 'admin' ? '管理员' : '普通用户'}，店铺：${shopInput}`;
				recordOperationLog(operationType, operationDesc, 'success');

				showToast(editUserName ? '用户编辑成功！' : '用户新增成功！', 'success');
				closeUserModal();
				loadAllUsers(); // 重新加载数据
			})
			.catch(err => {
				console.error('保存用户失败：', err);
				showToast(err.message || '保存用户失败，请重试！', 'error');
			});
	}

	/**
	 * 删除用户
	 */
	function deleteUser(userName) {
		if (userName === PROTECTED_ADMIN_USER) {
			showToast(`超级管理员账户【${PROTECTED_ADMIN_USER}】禁止删除！`, 'error');
			recordOperationLog('删除用户', `尝试删除超级管理员【${userName}】，操作被拒绝`, 'fail');
			return;
		}

		if (!confirm(`确定删除用户【${userName}】吗？`)) return;

		$(`.btn-delete-user[data-username="${userName}"]`).prop("disabled", true).text("删除中...");

		fetch("/data/userdata.json?t=" + new Date().getTime(), {
				cache: "no-cache"
			})
			.then(res => {
				if (!res.ok) throw new Error("读取数据失败");
				return res.json();
			})
			.then(list => {
				var newList = list.filter(u => u.userName != userName);

				return fetch("/aspx/SaveUserData.aspx", {
					method: "POST",
					headers: {
						"Content-Type": "application/x-www-form-urlencoded"
					},
					body: "data=" + encodeURIComponent(JSON.stringify(newList, null, 2))
				});
			})
			.then(res => {
				if (!res.ok) throw new Error("提交删除请求失败");
				return res.json();
			})
			.then(result => {
				if (!result.success) throw new Error(result.msg || "删除失败");

				// 记录成功日志
				recordOperationLog('删除用户', `删除用户【${userName}】成功`, 'success');

				$(`tr[data-username="${userName}"]`).fadeOut(300, function() {
					$(this).remove();
					loadAllUsers();
				});
				showToast("用户删除成功！", 'success');
			})
			.catch(err => {
				$(`.btn-delete-user[data-username="${userName}"]`).prop("disabled", false).html(
					'<i class="fa fa-trash"></i> 删除');
				// 记录失败日志
				recordOperationLog('删除用户', `删除用户【${userName}】失败：${err.message}`, 'fail');
				showToast("删除失败：" + err.message, 'error');
				console.error("删除失败：", err);
			});
	}

	// 将初始化函数挂载到window，供主页面调用
	window.initUserManagement = initUserManagement;
</script>